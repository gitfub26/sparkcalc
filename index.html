<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GigTracker V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        ios: { bg: '#F2F2F7', card: '#FFFFFF', darkBg: '#000000', darkCard: '#1C1C1E' }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        .no-scroll::-webkit-scrollbar { display: none; }
        .no-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-ios-bg dark:bg-ios-darkBg text-black dark:text-white transition-colors duration-300 flex flex-col h-screen overflow-hidden">

    <div id="statusPill" class="absolute top-12 right-6 z-50 hidden bg-blue-600 text-white px-3 py-1 text-[10px] font-bold rounded-full shadow-lg animate-pulse">
        PROCESSING...
    </div>

    <main class="flex-1 overflow-y-auto no-scroll px-4 pt-12 pb-44">
        
        <div class="mb-6">
            <h1 class="text-3xl font-extrabold tracking-tight">Earnings</h1>
            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">Unified Stream</p>
        </div>

        <div class="bg-white dark:bg-ios-darkCard rounded-[32px] p-6 shadow-sm border border-gray-200 dark:border-gray-800 mb-6">
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">TOTAL</span>
            <div class="text-5xl font-black tracking-tighter mt-2 text-gray-900 dark:text-white">
                $<span id="totalDisplay">0.00</span>
            </div>
            <div class="flex gap-2 mt-4" id="badges">
                </div>
        </div>

        <div id="feed" class="space-y-3 pb-20">
            </div>

    </main>

    <div class="fixed bottom-0 left-0 w-full p-5 bg-gradient-to-t from-[#F2F2F7] via-[#F2F2F7] to-transparent dark:from-black dark:via-black z-30 pt-12">
        <div class="grid grid-cols-2 gap-3 mb-3">
             <button onclick="clearData()" class="h-12 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 text-red-500 font-bold text-xs uppercase tracking-wider">
                Reset
            </button>
            <button onclick="toggleTheme()" class="h-12 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 text-gray-500 font-bold text-xs uppercase tracking-wider">
                Theme
            </button>
        </div>
        <label class="h-14 bg-black dark:bg-white text-white dark:text-black rounded-2xl shadow-xl flex items-center justify-center gap-2 cursor-pointer active:scale-95 transition-transform">
            <i class="ph-bold ph-camera text-xl"></i>
            <span class="font-bold text-sm tracking-widest">SCAN SCREENSHOT</span>
            <input type="file" id="fileInput" accept="image/*" multiple class="hidden" onchange="handleUpload(this.files)">
        </label>
    </div>

    <script>
        // --- LOGIC ENGINE ---

        // 1. Data Store
        let ENTRIES = [];
        let WORKER = null;

        // 2. Initialization
        window.addEventListener('DOMContentLoaded', async () => {
            initTheme();
            loadData();
            render();
            await initWorker();
        });

        async function initWorker() {
            try {
                WORKER = await Tesseract.createWorker('eng', 1, {
                    logger: m => {
                        const pill = document.getElementById('statusPill');
                        if (m.status === 'recognizing text') {
                            pill.innerText = `READING ${(m.progress * 100).toFixed(0)}%`;
                            pill.classList.remove('hidden');
                        } else if (m.status === 'initialized') {
                            pill.classList.add('hidden');
                        }
                    }
                });
            } catch(e) { console.error(e); }
        }

        // 3. Image Handling (The "Splitter")
        async function handleUpload(files) {
            const fileList = Array.from(files);
            if(fileList.length === 0) return;

            // Add placeholder for visual feedback
            const tempId = Date.now();
            ENTRIES.unshift({
                id: tempId,
                type: 'scanning',
                timestamp: Date.now()
            });
            render();

            for (let file of fileList) {
                await processFile(file, tempId);
            }
        }

        async function processFile(file, tempId) {
            // A. Pre-Process Image (Make it High Contrast for OCR)
            const processedImg = await preprocessImage(file);
            
            // B. Run OCR
            if(!WORKER) await initWorker();
            const { data: { text } } = await WORKER.recognize(processedImg);
            
            // C. Parse & Split
            const newItems = parseTextAndSplit(text);

            // D. Update Data
            // Remove the "scanning" placeholder
            ENTRIES = ENTRIES.filter(e => e.id !== tempId);
            
            if (newItems.length > 0) {
                // Add all found items to the list
                newItems.forEach(item => {
                    ENTRIES.unshift(item);
                });
            } else {
                // Determine error or empty
                console.log("No data found in:", text);
            }

            saveData();
            render();
        }

        // 4. The Brain: Image Pre-processing
        // This fixes the issue where "$" are missed because they are grey/faint
        function preprocessImage(file) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // Resize to manageable width
                    const scale = 1500 / img.width;
                    canvas.width = 1500;
                    canvas.height = img.height * scale;
                    
                    // Filter: Grayscale + High Contrast
                    ctx.filter = 'grayscale(100%) contrast(200%)';
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Convert back to blob
                    canvas.toBlob(blob => resolve(blob));
                };
            });
        }

        // 5. The Parser: Extraction Logic
        function parseTextAndSplit(text) {
            let results = [];
            const t = text;

            // --- STRATEGY 1: DOORDASH LIST VIEW ---
            // Pattern: Date -> Newline(maybe) -> Money
            // Regex handles the messiness of OCR
            // Matches: "Friday, Feb 13" ... "$17.45"
            const ddRegex = /(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\w*,?\s*([A-Z][a-z]{2})\s+(\d{1,2})[\s\S]{0,40}?(?:[\$S5])\s?(\d+\.\d{2})/gi;
            
            let ddMatches;
            while ((ddMatches = ddRegex.exec(t)) !== null) {
                results.push({
                    id: Date.now() + Math.random(),
                    type: 'doordash',
                    dateStr: `${ddMatches[2]} ${ddMatches[3]}`, // "Feb 13"
                    amount: parseFloat(ddMatches[4]),
                    timestamp: new Date().getTime() // sorting
                });
            }

            // --- STRATEGY 2: SPARK TRIP VIEW ---
            // Pattern: "Trip #1234" ... "$20.50"
            const sparkRegex = /Trip\s*#(\d+)[\s\S]{0,100}?(?:[\$S5])\s?(\d+\.\d{2})/gi;
            
            let sparkMatches;
            while ((sparkMatches = sparkRegex.exec(t)) !== null) {
                // Try to find a date in the header for context
                const headerDate = t.match(/([A-Z][a-z]{2})\s(\d{1,2})/); 
                const dateLabel = headerDate ? `${headerDate[1]} ${headerDate[2]}` : "Spark Trip";

                results.push({
                    id: Date.now() + Math.random(),
                    type: 'spark',
                    dateStr: dateLabel,
                    subLabel: `#${sparkMatches[1]}`,
                    amount: parseFloat(sparkMatches[2]),
                    timestamp: new Date().getTime()
                });
            }

            // --- STRATEGY 3: FALLBACK (SINGLE TOTAL) ---
            // If we found nothing specific, but see "This Dash" or "Earnings"
            if (results.length === 0) {
                // DoorDash Map Screen
                if (/this dash/i.test(t)) {
                    const money = t.match(/(?:[\$S5])\s?(\d+\.\d{2})/);
                    if (money) {
                        results.push({
                            id: Date.now(), type: 'doordash',
                            dateStr: 'Current Dash', amount: parseFloat(money[1]), timestamp: Date.now()
                        });
                    }
                }
                // Spark Weekly
                else if (/Earnings/i.test(t)) {
                     const money = t.match(/Earnings[\s\S]{0,20}(?:[\$S5])\s?(\d+\.\d{2})/i);
                     if (money) {
                        results.push({
                            id: Date.now(), type: 'spark',
                            dateStr: 'Weekly Summary', amount: parseFloat(money[1]), timestamp: Date.now()
                        });
                     }
                }
            }

            return results;
        }

        // 6. Rendering
        function render() {
            const feed = document.getElementById('feed');
            const totalEl = document.getElementById('totalDisplay');
            const badges = document.getElementById('badges');
            
            // Calc Total
            const validItems = ENTRIES.filter(e => e.type !== 'scanning');
            const total = validItems.reduce((acc, curr) => acc + curr.amount, 0);
            totalEl.innerText = total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Badges
            const hasDD = validItems.some(e => e.type === 'doordash');
            const hasSpark = validItems.some(e => e.type === 'spark');
            let badgeHtml = '';
            if(hasDD) badgeHtml += `<span class="px-2 py-1 bg-red-100 text-red-600 rounded text-[10px] font-bold tracking-wider">DOORDASH</span>`;
            if(hasSpark) badgeHtml += `<span class="px-2 py-1 bg-blue-100 text-blue-600 rounded text-[10px] font-bold tracking-wider">SPARK</span>`;
            badges.innerHTML = badgeHtml;

            // Render List
            let html = '';
            ENTRIES.forEach(item => {
                if (item.type === 'scanning') {
                    html += `
                    <div class="h-20 rounded-2xl bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-800 flex items-center justify-center animate-pulse">
                        <span class="text-xs font-bold text-gray-400">ANALYZING IMAGE...</span>
                    </div>`;
                    return;
                }

                // Styling based on platform
                const isDD = item.type === 'doordash';
                const colorClass = isDD ? 'bg-red-500' : 'bg-blue-600';
                const iconClass = isDD ? 'ph-hamburger' : 'ph-lightning';
                const iconBg = isDD ? 'bg-red-50 text-red-500 dark:bg-red-900/20' : 'bg-blue-50 text-blue-500 dark:bg-blue-900/20';
                const borderColor = isDD ? 'border-red-100 dark:border-red-900/30' : 'border-blue-100 dark:border-blue-900/30';

                html += `
                <div class="relative bg-white dark:bg-ios-darkCard p-4 rounded-2xl border ${borderColor} shadow-sm flex justify-between items-center group">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full ${iconBg} flex items-center justify-center shrink-0">
                            <i class="ph-fill ${iconClass} text-xl"></i>
                        </div>
                        
                        <div>
                            <div class="text-sm font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                ${item.dateStr}
                                ${item.subLabel ? `<span class="text-[10px] bg-gray-100 dark:bg-gray-700 px-1 rounded text-gray-500">${item.subLabel}</span>` : ''}
                            </div>
                            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mt-0.5">
                                ${item.type}
                            </div>
                        </div>
                    </div>

                    <div class="text-right">
                        <div class="text-lg font-black text-gray-900 dark:text-white">
                            +$${item.amount.toFixed(2)}
                        </div>
                         <button onclick="deleteItem(${item.id})" class="text-[10px] text-red-400 font-bold uppercase mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            Remove
                        </button>
                    </div>
                </div>
                `;
            });

            feed.innerHTML = html;
        }

        // 7. Persistence & Utils
        function deleteItem(id) {
            ENTRIES = ENTRIES.filter(e => e.id !== id);
            saveData();
            render();
        }

        function clearData() {
            if(confirm('Clear history?')) {
                ENTRIES = [];
                saveData();
                render();
            }
        }

        function saveData() { localStorage.setItem('gigtracker_v3', JSON.stringify(ENTRIES)); }
        function loadData() {
            const data = localStorage.getItem('gigtracker_v3');
            if(data) ENTRIES = JSON.parse(data);
        }

        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
        }
    </script>
</body>
</html>
